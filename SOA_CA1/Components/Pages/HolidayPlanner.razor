@page "/holiday"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Forms
@inject SOA_CA1.Services.Holidays.IHolidayService Holidays
@inject SOA_CA1.Services.Currency.IExchangeService Fx
@using SOA_CA1.Models
@using SOA_CA1.Data

<h3>Holiday Planner</h3>

<div class="mb-3">
    <label class="form-label">Date:</label>
    <InputDate @bind-Value="date" class="form-control" />
</div>

<div class="mb-3">
    <label class="form-label">Country:</label>
    <InputSelect @bind-Value="country" class="form-select">
        @foreach (var c in countries)
        {
            <option value="@c.Code">@c.Name (@c.Code)</option>
        }
    </InputSelect>
</div>

<div class="mb-3">
    <label class="form-label">Budget:</label>
    <InputNumber @bind-Value="amount" class="form-control" step="0.01" />
</div>
<div class="mb-3">
    <label class="form-label">From Currency (e.g., EUR):</label>
    <InputText @bind-Value="fromCur" class="form-control" />
</div>
<div class="mb-3">
    <label class="form-label">To Currency (e.g., USD):</label>
    <InputText @bind-Value="toCur" class="form-control" />
</div>

<button class="btn btn-primary" @onclick="Check" disabled="@checking">Check</button>

@if (checking)
{
    <p class="mt-3">Checking…</p>
}

@if (!checking)
{
    <p class="mt-3">@status</p>

    @if (converted is not null)
    {
        <p class="mt-2">
            @amount @fromCur → @toCur =
            <strong>@converted.Value.ToString("0.00")</strong>
        </p>
    }
    else if (checkedOnce)
    {
        <p class="mt-2 text-warning">Couldn’t get a conversion just now.</p>
    }
}
@if (suggestions.Count > 0)
{
    <h5 class="mt-3">Tips</h5>
    <ul>
        @foreach (var s in suggestions)
        {
            <li>@s.Message</li>
        }
    </ul>
}

@code {
    DateOnly date = DateOnly.FromDateTime(DateTime.Today);
    string country = "IE";

    bool checking;
    bool checkedOnce;
    string status = "Not checked yet";

    decimal amount = 100m;
    string fromCur = "EUR";
    string toCur = "USD";
    decimal? converted;

    List<Suggestion> suggestions = new();

    List<CountryData.CountryOption> countries = CountryData.All;

    static bool IsWeekend(DateOnly d)
    => d.DayOfWeek is DayOfWeek.Saturday or DayOfWeek.Sunday;

    async Task Check()
    {
        checking = true; checkedOnce = false; status = "Checking…";
        try
        {
            var isHoliday = await Holidays.IsPublicHolidayAsync(date, country.ToUpperInvariant());
            status = isHoliday ? "Public holiday " : "Not a public holiday";

            converted = await Fx.ConvertAsync(
                amount, fromCur.ToUpperInvariant(), toCur.ToUpperInvariant());

            suggestions.Clear();

            var dayType = DayType.Weekday;
            if (status.StartsWith("Public holiday")) dayType = DayType.PublicHoliday;
            else if (IsWeekend(date)) dayType = DayType.Weekend;

            suggestions.Add(dayType switch
            {
                DayType.PublicHoliday => new Suggestion { Message = "Expect closures/celebrations—book attractions in advance.", Type = dayType, Priority = 0 },
                DayType.Weekend => new Suggestion { Message = "Weekend crowds—book transport early.", Type = dayType, Priority = 1 },
                _ => new Suggestion { Message = "Weekday—often cheaper flights/hotels.", Type = dayType, Priority = 2 },
            });

            if (converted is not null)
            {
                if (converted < 50)
                    suggestions.Add(new Suggestion { Message = "Tight budget: stick to free parks & museums.", Type = dayType, Priority = 3 });
                else if (converted < 150)
                    suggestions.Add(new Suggestion { Message = "Comfortable: add one paid attraction.", Type = dayType, Priority = 4 });
                else
                    suggestions.Add(new Suggestion { Message = "High budget: upgrade dining or activities.", Type = dayType, Priority = 5 });
            }

            suggestions.Sort();

            checkedOnce = true;
        }
        catch (Exception ex)
        {
            status = $"Error: {ex.Message}";
            converted = null;
            checkedOnce = true;
        }
        finally
        {
            checking = false;
        }
    }
}
